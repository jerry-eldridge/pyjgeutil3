#include <stdio.h>
#include <iostream>
using namespace std;
#include <list>

#include <math.h>
#include <errno.h>
#include <string.h>

#include "MarchingCubes.h"

//extern FILE *g_fp;
extern FILE *g_fp_v;
extern FILE *g_fp_f;
extern FILE *g_fp_n;
extern int g_v_n;
extern int g_t_n;
extern int DLOW;
extern int DHI;
extern int DN;

Graph voxel; // make "voxel" global, using "g_voxel"

extern list<Vector3D> g_vertices;
extern list<Vector3D> g_normals;
extern list<Face> g_faces;

// SS = Subset
VertexSubset VertexSubsets[VSS_CARD];  // All subsets of the Vertex Set
EdgeSubset EdgeSubsets[ESS_CARD];      // All subsets of the Edge Set

float V_Voxel_LocalCoords[3*V_CARD] = { // Local Coord. Reference Frame
        0.0, 0.0, 0.0,
                1.0, 0.0, 0.0,
                1.0, 1.0, 0.0,
                0.0, 1.0, 0.0,
        0.0, 0.0, 1.0,
                1.0, 0.0, 1.0,
                1.0, 1.0, 1.0,
                0.0, 1.0, 1.0
};
VertexLabel E_Voxel[2*E_CARD] = {                       // Edge list in terms of VertexLabel
        0,1, 1,2, 2,3, 3,0,
        4,5, 5,6, 6,7, 7,4,
        0,4, 1,5, 2,6, 3,7
};

//Vector3D EdgeDirectionVectors[3*E_CARD] = {
//        1.0, 0.0, 0.0,
//              0.0, 1.0, 0.0,
//              -1.0, 0.0, 0.0,
//              0.0, -1.0, 0.0,
//        1.0, 0.0, 0.0,
//              0.0, 1.0, 0.0,
//              -1.0, 0.0, 0.0,
//              0.0, -1.0, 0.0,
//        0.0, 0.0, 1.0,
//              0.0, 0.0, 1.0,
//              0.0, 0.0, 1.0,
//              0.0,  0.0, 1.0
//};


float Phi(float x, float y, float z)
{
        Vector3D pt;
        pt.x = x; pt.y = y; pt.z = z;
        return Phi3D(pt);
}

void MC_Initialize()
{
        int i;
        for (i = 0; i<V_CARD; i++) {
                voxel.v[i].x = V_Voxel_LocalCoords[3*i];
                voxel.v[i].y = V_Voxel_LocalCoords[3*i+1];
                voxel.v[i].z = V_Voxel_LocalCoords[3*i+2];
                voxel.v[i].n = i;
        }

        for (i = 0; i<E_CARD; i++) {
                voxel.e[i].v0 = E_Voxel[2*i];
                voxel.e[i].v1 = E_Voxel[2*i+1];
                voxel.e[i].n  = i;
        }
}

Vector3D VertexToVector3D(Vertex v)
{
        Vector3D vect;
        vect.x = v.x;
        vect.y = v.y;
        vect.z = v.z;
        return vect;
}

// Values Phi0 and Phi1 are given. These are points
// (0, Phi0) and (1, Phi1). Find x or t such that
// F(v_t) = 0, or Phi(v_t) = Threshold.
// The slope is slope = rise/run = (Phi1 - Phi0)/(1-0).
//
// And a point is (0, Phi0), so using point-slope
// form for a line, y - y0 = slope*(x-x0). Solve for x,
// which is t, to get (y-y0)/slope + x0 = x; Use
// (x0, y0) = (0, Phi0). So x = (y - Phi0)/slope.
//
// Use y = Threshold, to get x = (Threshold - Phi0)/slope
float fLinearInterpolation(float Phi0, float Phi1, float Threshold)
{
        double slope = Phi1 - Phi0;
        double x, y, x0, y0;

        // Phi_t = Threshold, t = x.
        x0 = 0; y0 = Phi0; y = Threshold;
        x = (y - y0)/slope + x0;
        return x;
}

// Gradient of the Potential Phi.
//
// Note for conservative force,F, we have Del x F = 0.
// Then F = -grad Phi for some scalar field Phi.
//
// Instead of storing a vector field, F, we store a scalar
// field, Phi at one-third the diskspace size. (Instead of
// (x,y,z) we store Phi).
//
// Phi thought of as iso-lines or contour lines is like
// a mountain with those contour lines. The gradient tells
// which direction the mountain is travelling straight up.
Vector3D Gradient(Vector3D r, float epsilon)
{
        // epsilon is a small number, eg epsilon = 0.01
        Vector3D grad_phi;
        float x, y, z;
        float constant = 1.0; // "2*epsilon" which only scales the magnitude


        x = r.x; y = r.y; z = r.z; // position

        // Notice that this gives a vector multiplied by a scalar constant
        grad_phi.x = -(Phi(x+epsilon,y,z) - Phi(x-epsilon,y,z))/constant;
        grad_phi.y = -(Phi(x, y+epsilon,z) - Phi(x, y-epsilon,z))/constant;
        grad_phi.z = -(Phi(x,y,z+epsilon) - Phi(x, y, z-epsilon))/constant;

        return grad_phi; // actually, -grad_phi(xyz)
}

Vector3D VertexPointNormal(Vector3D pt)
{
        Vector3D ptNormal;
        float epsilon = 0.01;

        ptNormal =  Gradient(pt, epsilon); // ptNormal = -grad Phi, at pt
        ptNormal = VectorNormalize(ptNormal);

        return ptNormal;
}


VertexSubset VertexSubsetAddElement(VertexSubset set, VertexLabel element)
{
        return (set | (1 << element));
}
EdgeSubset EdgeSubsetAddElement(EdgeSubset set, EdgeLabel element)
{
        return (set | (1 << element));
}
VertexSubset VertexSubsetRemoveElement(VertexSubset set, VertexLabel element
)
{
        return (set & ~(1 << element));
}
EdgeSubset EdgeSubsetRemoveElement(EdgeSubset set, EdgeLabel element)
{
        return (set & ~(1 << element));
}

Vector3D vLinearInterpolation(Vector3D v0, Vector3D v1, float Threshold)
{
        float Phi0 = Phi3D(v0);
        float Phi1 = Phi3D(v1);
        float t = fLinearInterpolation(Phi0, Phi1, Threshold);
        Vector3D v_t, res;
        //Vertex vrtx;

        res = VectorScalarMult(v0, -1.0);               // -v0
        res = VectorAdd(v1, res);                               // v1 - v0
        res = VectorScalarMult(res, t);                 // t(v1-v0)
        v_t = VectorAdd(v0, res);                               // v_t = v0+ t(v1-v0)

        return v_t;
}

// "For any edge, if one vertex is inside of the surface and the other is outside of the surface
// then the edge intersects the surface
// For each of the 8 vertices of the cube can be two possible states : either inside or outside of the surface
// For any cube the are 2^8=256 possible sets of vertex states
// This table lists the edges intersected by the surface for all 256 possible vertex states
// There are 12 edges.  For each entry in the table, if edge #n is intersected, then bit #n is set to 1"
// (see Paul Bourke's website.) Marching Cubes Example Program by Cory Bloyd(corysama@yahoo.com)
// For a description of the algorithm go to http://astronomy.swin.edu.au/pbourke/modelling/polygonise/
// The code is public domain.
//
// VertexSubsets are numbers up to 2^8 since there are 8 vertices and a vertex is either inside
// the surface or outside. If the vertex is inside, its i-th bit is set. Likewise, an EdgeSubset
// of Voxel = (V, E) of E, ... there are 12 edges so EdgeSubsets are numbersup to 2^12 or from
// 0x000 to 0xFFF. Below uses hexadecimal numbers to denote subsets or sets.Likewise 0 to 255 is
// viewed as a subset of the vertices.

// 2^8 = 256 VertexSubsets
EdgeSubset Map_VertexSubset_To_EdgeSubset[VSS_CARD]=
{
        0x000, 0x109, 0x203, 0x30a, 0x406, 0x50f, 0x605, 0x70c, 0x80c, 0x905
, 0xa0f, 0xb06, 0xc0a, 0xd03, 0xe09, 0xf00,
        0x190, 0x099, 0x393, 0x29a, 0x596, 0x49f, 0x795, 0x69c, 0x99c, 0x895
, 0xb9f, 0xa96, 0xd9a, 0xc93, 0xf99, 0xe90,
        0x230, 0x339, 0x033, 0x13a, 0x636, 0x73f, 0x435, 0x53c, 0xa3c, 0xb35
, 0x83f, 0x936, 0xe3a, 0xf33, 0xc39, 0xd30,
        0x3a0, 0x2a9, 0x1a3, 0x0aa, 0x7a6, 0x6af, 0x5a5, 0x4ac, 0xbac, 0xaa5
, 0x9af, 0x8a6, 0xfaa, 0xea3, 0xda9, 0xca0,
        0x460, 0x569, 0x663, 0x76a, 0x066, 0x16f, 0x265, 0x36c, 0xc6c, 0xd65
, 0xe6f, 0xf66, 0x86a, 0x963, 0xa69, 0xb60,
        0x5f0, 0x4f9, 0x7f3, 0x6fa, 0x1f6, 0x0ff, 0x3f5, 0x2fc, 0xdfc, 0xcf5
, 0xfff, 0xef6, 0x9fa, 0x8f3, 0xbf9, 0xaf0,
        0x650, 0x759, 0x453, 0x55a, 0x256, 0x35f, 0x055, 0x15c, 0xe5c, 0xf55
, 0xc5f, 0xd56, 0xa5a, 0xb53, 0x859, 0x950,
        0x7c0, 0x6c9, 0x5c3, 0x4ca, 0x3c6, 0x2cf, 0x1c5, 0x0cc, 0xfcc, 0xec5
, 0xdcf, 0xcc6, 0xbca, 0xac3, 0x9c9, 0x8c0,
        0x8c0, 0x9c9, 0xac3, 0xbca, 0xcc6, 0xdcf, 0xec5, 0xfcc, 0x0cc, 0x1c5
, 0x2cf, 0x3c6, 0x4ca, 0x5c3, 0x6c9, 0x7c0,
        0x950, 0x859, 0xb53, 0xa5a, 0xd56, 0xc5f, 0xf55, 0xe5c, 0x15c, 0x055
, 0x35f, 0x256, 0x55a, 0x453, 0x759, 0x650,
        0xaf0, 0xbf9, 0x8f3, 0x9fa, 0xef6, 0xfff, 0xcf5, 0xdfc, 0x2fc, 0x3f5
, 0x0ff, 0x1f6, 0x6fa, 0x7f3, 0x4f9, 0x5f0,
        0xb60, 0xa69, 0x963, 0x86a, 0xf66, 0xe6f, 0xd65, 0xc6c, 0x36c, 0x265
, 0x16f, 0x066, 0x76a, 0x663, 0x569, 0x460,
        0xca0, 0xda9, 0xea3, 0xfaa, 0x8a6, 0x9af, 0xaa5, 0xbac, 0x4ac, 0x5a5
, 0x6af, 0x7a6, 0x0aa, 0x1a3, 0x2a9, 0x3a0,
        0xd30, 0xc39, 0xf33, 0xe3a, 0x936, 0x83f, 0xb35, 0xa3c, 0x53c, 0x435
, 0x73f, 0x636, 0x13a, 0x033, 0x339, 0x230,
        0xe90, 0xf99, 0xc93, 0xd9a, 0xa96, 0xb9f, 0x895, 0x99c, 0x69c, 0x795
, 0x49f, 0x596, 0x29a, 0x393, 0x099, 0x190,
        0xf00, 0xe09, 0xd03, 0xc0a, 0xb06, 0xa0f, 0x905, 0x80c, 0x70c, 0x605
, 0x50f, 0x406, 0x30a, 0x203, 0x109, 0x000
};

// A List of up to five triangles. End of list indicated by sentinel
// value -1. Each triangle is 3 vertices. The Triangle List is
// is given by listing out the vertice's labels.
//
//  JGE. Below lists 16 values. If the value is -1 its considered the end ofthe
// Triangle List. Its called a sentinel value which tells you the list is over.
// For convenience, a Triangle list has exactly 16 numbers, which is 15 numbers
// followed by a -1 sentinel value. That is 5 x 3 or Up to Five triangles. Atriangle
// is three vertices or points.
//
// The first Triangle list for vertex subset 0 = 00000000, is {-1, -1, ... which means its
// empty because it starts with -1, the sentinel value. The next triangle list is for
// vertex subset 1 = 0000 0001 which means v_0 is inside the surface. The below map
// says the triangle is 0-8-3, where 0, 8, and 3 are edges. The EdgeLabel 0is actually
// 01 a line between vertex points 0 and 1. EdgeLabel 8 is 04. EdgeLabel 3 is 03. Since
// vertex subset 1 means v_0 is inside the surface. Then 01, 04, and 03 have0 inside
// the surface and points 1, 4, and 3 outside. And each edge 01, 04, 03 intersects the
// surface. You calculated the intersection point, which are three intersection points.
// Since three points make up a triangle, that triangle is denoted simply by0-8-3
// denoting the edges that have intersection points. The normals to verticesare
// calculated using the Gradient.
//
// EdgeLabel 0, 1, 2, 3 or the 3rd list below is 1-8-3 and 9-8-1 followed by

// a sentinel value of -1 indicating end of triangle list. Each of 1, 8, and3
// are edges that intersect the surface. Since the VertexSubset Label here is 3,
// then 3 = 0000 0011 = means v_1 and v_0 are inside the surface. Looking atthe
// i-th place in the binary number. If the ith place is 1 then that vertex is
// inside, else its outside the surface. So points 1 and 0 are inside the surface.
// The Edges 1-8-3 are 12, 40, and 30 using vertex labels to denote edges.
// So 1 and 0 are inside vertices, and 2, 4, and 3 are outside vertices. Inbetween
// are points that intersect the surface on those edges of 1, 8, and 3. Those
// three points make up a triangle. Likewise, 9-8-1 list of edges indicates
// three intersection points on their edges, and so 9-8-1 indicates a triangle.
//
// Below gives from 0 to 5 possible triangles for each VertexSubset.
//
VertexLabel Map_VertexSubset_To_TriangleList[VSS_CARD*(3*5+1)] =
{
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 8, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 1, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 8, 3, 9, 8, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 2, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 8, 3, 1, 2, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        9, 2, 10, 0, 2, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        2, 8, 3, 2, 10, 8, 10, 9, 8, -1, -1, -1, -1, -1, -1, -1,
        3, 11, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 11, 2, 8, 11, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 9, 0, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 11, 2, 1, 9, 11, 9, 8, 11, -1, -1, -1, -1, -1, -1, -1,
        3, 10, 1, 11, 10, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 10, 1, 0, 8, 10, 8, 11, 10, -1, -1, -1, -1, -1, -1, -1,
        3, 9, 0, 3, 11, 9, 11, 10, 9, -1, -1, -1, -1, -1, -1, -1,
        9, 8, 10, 10, 8, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        4, 7, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        4, 3, 0, 7, 3, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 1, 9, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        4, 1, 9, 4, 7, 1, 7, 3, 1, -1, -1, -1, -1, -1, -1, -1,
        1, 2, 10, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        3, 4, 7, 3, 0, 4, 1, 2, 10, -1, -1, -1, -1, -1, -1, -1,
        9, 2, 10, 9, 0, 2, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1,
        2, 10, 9, 2, 9, 7, 2, 7, 3, 7, 9, 4, -1, -1, -1, -1,
        8, 4, 7, 3, 11, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        11, 4, 7, 11, 2, 4, 2, 0, 4, -1, -1, -1, -1, -1, -1, -1,
        9, 0, 1, 8, 4, 7, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1,
        4, 7, 11, 9, 4, 11, 9, 11, 2, 9, 2, 1, -1, -1, -1, -1,
        3, 10, 1, 3, 11, 10, 7, 8, 4, -1, -1, -1, -1, -1, -1, -1,
        1, 11, 10, 1, 4, 11, 1, 0, 4, 7, 11, 4, -1, -1, -1, -1,
        4, 7, 8, 9, 0, 11, 9, 11, 10, 11, 0, 3, -1, -1, -1, -1,
        4, 7, 11, 4, 11, 9, 9, 11, 10, -1, -1, -1, -1, -1, -1, -1,
        9, 5, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        9, 5, 4, 0, 8, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 5, 4, 1, 5, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        8, 5, 4, 8, 3, 5, 3, 1, 5, -1, -1, -1, -1, -1, -1, -1,
        1, 2, 10, 9, 5, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        3, 0, 8, 1, 2, 10, 4, 9, 5, -1, -1, -1, -1, -1, -1, -1,
        5, 2, 10, 5, 4, 2, 4, 0, 2, -1, -1, -1, -1, -1, -1, -1,
        2, 10, 5, 3, 2, 5, 3, 5, 4, 3, 4, 8, -1, -1, -1, -1,
        9, 5, 4, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 11, 2, 0, 8, 11, 4, 9, 5, -1, -1, -1, -1, -1, -1, -1,
        0, 5, 4, 0, 1, 5, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1,
        2, 1, 5, 2, 5, 8, 2, 8, 11, 4, 8, 5, -1, -1, -1, -1,
        10, 3, 11, 10, 1, 3, 9, 5, 4, -1, -1, -1, -1, -1, -1, -1,
        4, 9, 5, 0, 8, 1, 8, 10, 1, 8, 11, 10, -1, -1, -1, -1,
        5, 4, 0, 5, 0, 11, 5, 11, 10, 11, 0, 3, -1, -1, -1, -1,
        5, 4, 8, 5, 8, 10, 10, 8, 11, -1, -1, -1, -1, -1, -1, -1,
        9, 7, 8, 5, 7, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        9, 3, 0, 9, 5, 3, 5, 7, 3, -1, -1, -1, -1, -1, -1, -1,
        0, 7, 8, 0, 1, 7, 1, 5, 7, -1, -1, -1, -1, -1, -1, -1,
        1, 5, 3, 3, 5, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        9, 7, 8, 9, 5, 7, 10, 1, 2, -1, -1, -1, -1, -1, -1, -1,
        10, 1, 2, 9, 5, 0, 5, 3, 0, 5, 7, 3, -1, -1, -1, -1,
        8, 0, 2, 8, 2, 5, 8, 5, 7, 10, 5, 2, -1, -1, -1, -1,
        2, 10, 5, 2, 5, 3, 3, 5, 7, -1, -1, -1, -1, -1, -1, -1,
        7, 9, 5, 7, 8, 9, 3, 11, 2, -1, -1, -1, -1, -1, -1, -1,
        9, 5, 7, 9, 7, 2, 9, 2, 0, 2, 7, 11, -1, -1, -1, -1,
        2, 3, 11, 0, 1, 8, 1, 7, 8, 1, 5, 7, -1, -1, -1, -1,
        11, 2, 1, 11, 1, 7, 7, 1, 5, -1, -1, -1, -1, -1, -1, -1,
        9, 5, 8, 8, 5, 7, 10, 1, 3, 10, 3, 11, -1, -1, -1, -1,
        5, 7, 0, 5, 0, 9, 7, 11, 0, 1, 0, 10, 11, 10, 0, -1,
        11, 10, 0, 11, 0, 3, 10, 5, 0, 8, 0, 7, 5, 7, 0, -1,
        11, 10, 5, 7, 11, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        10, 6, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 8, 3, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        9, 0, 1, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 8, 3, 1, 9, 8, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1,
        1, 6, 5, 2, 6, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 6, 5, 1, 2, 6, 3, 0, 8, -1, -1, -1, -1, -1, -1, -1,
        9, 6, 5, 9, 0, 6, 0, 2, 6, -1, -1, -1, -1, -1, -1, -1,
        5, 9, 8, 5, 8, 2, 5, 2, 6, 3, 2, 8, -1, -1, -1, -1,
        2, 3, 11, 10, 6, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        11, 0, 8, 11, 2, 0, 10, 6, 5, -1, -1, -1, -1, -1, -1, -1,
        0, 1, 9, 2, 3, 11, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1,
        5, 10, 6, 1, 9, 2, 9, 11, 2, 9, 8, 11, -1, -1, -1, -1,
        6, 3, 11, 6, 5, 3, 5, 1, 3, -1, -1, -1, -1, -1, -1, -1,
        0, 8, 11, 0, 11, 5, 0, 5, 1, 5, 11, 6, -1, -1, -1, -1,
        3, 11, 6, 0, 3, 6, 0, 6, 5, 0, 5, 9, -1, -1, -1, -1,
        6, 5, 9, 6, 9, 11, 11, 9, 8, -1, -1, -1, -1, -1, -1, -1,
        5, 10, 6, 4, 7, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        4, 3, 0, 4, 7, 3, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1,
        1, 9, 0, 5, 10, 6, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1,
        10, 6, 5, 1, 9, 7, 1, 7, 3, 7, 9, 4, -1, -1, -1, -1,
        6, 1, 2, 6, 5, 1, 4, 7, 8, -1, -1, -1, -1, -1, -1, -1,
        1, 2, 5, 5, 2, 6, 3, 0, 4, 3, 4, 7, -1, -1, -1, -1,
        8, 4, 7, 9, 0, 5, 0, 6, 5, 0, 2, 6, -1, -1, -1, -1,
        7, 3, 9, 7, 9, 4, 3, 2, 9, 5, 9, 6, 2, 6, 9, -1,
        3, 11, 2, 7, 8, 4, 10, 6, 5, -1, -1, -1, -1, -1, -1, -1,
        5, 10, 6, 4, 7, 2, 4, 2, 0, 2, 7, 11, -1, -1, -1, -1,
        0, 1, 9, 4, 7, 8, 2, 3, 11, 5, 10, 6, -1, -1, -1, -1,
        9, 2, 1, 9, 11, 2, 9, 4, 11, 7, 11, 4, 5, 10, 6, -1,
        8, 4, 7, 3, 11, 5, 3, 5, 1, 5, 11, 6, -1, -1, -1, -1,
        5, 1, 11, 5, 11, 6, 1, 0, 11, 7, 11, 4, 0, 4, 11, -1,
        0, 5, 9, 0, 6, 5, 0, 3, 6, 11, 6, 3, 8, 4, 7, -1,
        6, 5, 9, 6, 9, 11, 4, 7, 9, 7, 11, 9, -1, -1, -1, -1,
        10, 4, 9, 6, 4, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        4, 10, 6, 4, 9, 10, 0, 8, 3, -1, -1, -1, -1, -1, -1, -1,
        10, 0, 1, 10, 6, 0, 6, 4, 0, -1, -1, -1, -1, -1, -1, -1,
        8, 3, 1, 8, 1, 6, 8, 6, 4, 6, 1, 10, -1, -1, -1, -1,
        1, 4, 9, 1, 2, 4, 2, 6, 4, -1, -1, -1, -1, -1, -1, -1,
        3, 0, 8, 1, 2, 9, 2, 4, 9, 2, 6, 4, -1, -1, -1, -1,
        0, 2, 4, 4, 2, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        8, 3, 2, 8, 2, 4, 4, 2, 6, -1, -1, -1, -1, -1, -1, -1,
        10, 4, 9, 10, 6, 4, 11, 2, 3, -1, -1, -1, -1, -1, -1, -1,
        0, 8, 2, 2, 8, 11, 4, 9, 10, 4, 10, 6, -1, -1, -1, -1,
        3, 11, 2, 0, 1, 6, 0, 6, 4, 6, 1, 10, -1, -1, -1, -1,
        6, 4, 1, 6, 1, 10, 4, 8, 1, 2, 1, 11, 8, 11, 1, -1,
        9, 6, 4, 9, 3, 6, 9, 1, 3, 11, 6, 3, -1, -1, -1, -1,
        8, 11, 1, 8, 1, 0, 11, 6, 1, 9, 1, 4, 6, 4, 1, -1,
        3, 11, 6, 3, 6, 0, 0, 6, 4, -1, -1, -1, -1, -1, -1, -1,
        6, 4, 8, 11, 6, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        7, 10, 6, 7, 8, 10, 8, 9, 10, -1, -1, -1, -1, -1, -1, -1,
        0, 7, 3, 0, 10, 7, 0, 9, 10, 6, 7, 10, -1, -1, -1, -1,
        10, 6, 7, 1, 10, 7, 1, 7, 8, 1, 8, 0, -1, -1, -1, -1,
        10, 6, 7, 10, 7, 1, 1, 7, 3, -1, -1, -1, -1, -1, -1, -1,
        1, 2, 6, 1, 6, 8, 1, 8, 9, 8, 6, 7, -1, -1, -1, -1,
        2, 6, 9, 2, 9, 1, 6, 7, 9, 0, 9, 3, 7, 3, 9, -1,
        7, 8, 0, 7, 0, 6, 6, 0, 2, -1, -1, -1, -1, -1, -1, -1,
        7, 3, 2, 6, 7, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        2, 3, 11, 10, 6, 8, 10, 8, 9, 8, 6, 7, -1, -1, -1, -1,
        2, 0, 7, 2, 7, 11, 0, 9, 7, 6, 7, 10, 9, 10, 7, -1,
        1, 8, 0, 1, 7, 8, 1, 10, 7, 6, 7, 10, 2, 3, 11, -1,
        11, 2, 1, 11, 1, 7, 10, 6, 1, 6, 7, 1, -1, -1, -1, -1,
        8, 9, 6, 8, 6, 7, 9, 1, 6, 11, 6, 3, 1, 3, 6, -1,
        0, 9, 1, 11, 6, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        7, 8, 0, 7, 0, 6, 3, 11, 0, 11, 6, 0, -1, -1, -1, -1,
        7, 11, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        7, 6, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        3, 0, 8, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 1, 9, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        8, 1, 9, 8, 3, 1, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1,
        10, 1, 2, 6, 11, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 2, 10, 3, 0, 8, 6, 11, 7, -1, -1, -1, -1, -1, -1, -1,
        2, 9, 0, 2, 10, 9, 6, 11, 7, -1, -1, -1, -1, -1, -1, -1,
        6, 11, 7, 2, 10, 3, 10, 8, 3, 10, 9, 8, -1, -1, -1, -1,
        7, 2, 3, 6, 2, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        7, 0, 8, 7, 6, 0, 6, 2, 0, -1, -1, -1, -1, -1, -1, -1,
        2, 7, 6, 2, 3, 7, 0, 1, 9, -1, -1, -1, -1, -1, -1, -1,
        1, 6, 2, 1, 8, 6, 1, 9, 8, 8, 7, 6, -1, -1, -1, -1,
        10, 7, 6, 10, 1, 7, 1, 3, 7, -1, -1, -1, -1, -1, -1, -1,
        10, 7, 6, 1, 7, 10, 1, 8, 7, 1, 0, 8, -1, -1, -1, -1,
        0, 3, 7, 0, 7, 10, 0, 10, 9, 6, 10, 7, -1, -1, -1, -1,
        7, 6, 10, 7, 10, 8, 8, 10, 9, -1, -1, -1, -1, -1, -1, -1,
        6, 8, 4, 11, 8, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        3, 6, 11, 3, 0, 6, 0, 4, 6, -1, -1, -1, -1, -1, -1, -1,
        8, 6, 11, 8, 4, 6, 9, 0, 1, -1, -1, -1, -1, -1, -1, -1,
        9, 4, 6, 9, 6, 3, 9, 3, 1, 11, 3, 6, -1, -1, -1, -1,
        6, 8, 4, 6, 11, 8, 2, 10, 1, -1, -1, -1, -1, -1, -1, -1,
        1, 2, 10, 3, 0, 11, 0, 6, 11, 0, 4, 6, -1, -1, -1, -1,
        4, 11, 8, 4, 6, 11, 0, 2, 9, 2, 10, 9, -1, -1, -1, -1,
        10, 9, 3, 10, 3, 2, 9, 4, 3, 11, 3, 6, 4, 6, 3, -1,
        8, 2, 3, 8, 4, 2, 4, 6, 2, -1, -1, -1, -1, -1, -1, -1,
        0, 4, 2, 4, 6, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 9, 0, 2, 3, 4, 2, 4, 6, 4, 3, 8, -1, -1, -1, -1,
        1, 9, 4, 1, 4, 2, 2, 4, 6, -1, -1, -1, -1, -1, -1, -1,
        8, 1, 3, 8, 6, 1, 8, 4, 6, 6, 10, 1, -1, -1, -1, -1,
        10, 1, 0, 10, 0, 6, 6, 0, 4, -1, -1, -1, -1, -1, -1, -1,
        4, 6, 3, 4, 3, 8, 6, 10, 3, 0, 3, 9, 10, 9, 3, -1,
        10, 9, 4, 6, 10, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        4, 9, 5, 7, 6, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 8, 3, 4, 9, 5, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1,
        5, 0, 1, 5, 4, 0, 7, 6, 11, -1, -1, -1, -1, -1, -1, -1,
        11, 7, 6, 8, 3, 4, 3, 5, 4, 3, 1, 5, -1, -1, -1, -1,
        9, 5, 4, 10, 1, 2, 7, 6, 11, -1, -1, -1, -1, -1, -1, -1,
        6, 11, 7, 1, 2, 10, 0, 8, 3, 4, 9, 5, -1, -1, -1, -1,
        7, 6, 11, 5, 4, 10, 4, 2, 10, 4, 0, 2, -1, -1, -1, -1,
        3, 4, 8, 3, 5, 4, 3, 2, 5, 10, 5, 2, 11, 7, 6, -1,
        7, 2, 3, 7, 6, 2, 5, 4, 9, -1, -1, -1, -1, -1, -1, -1,
        9, 5, 4, 0, 8, 6, 0, 6, 2, 6, 8, 7, -1, -1, -1, -1,
        3, 6, 2, 3, 7, 6, 1, 5, 0, 5, 4, 0, -1, -1, -1, -1,
        6, 2, 8, 6, 8, 7, 2, 1, 8, 4, 8, 5, 1, 5, 8, -1,
        9, 5, 4, 10, 1, 6, 1, 7, 6, 1, 3, 7, -1, -1, -1, -1,
        1, 6, 10, 1, 7, 6, 1, 0, 7, 8, 7, 0, 9, 5, 4, -1,
        4, 0, 10, 4, 10, 5, 0, 3, 10, 6, 10, 7, 3, 7, 10, -1,
        7, 6, 10, 7, 10, 8, 5, 4, 10, 4, 8, 10, -1, -1, -1, -1,
        6, 9, 5, 6, 11, 9, 11, 8, 9, -1, -1, -1, -1, -1, -1, -1,
        3, 6, 11, 0, 6, 3, 0, 5, 6, 0, 9, 5, -1, -1, -1, -1,
        0, 11, 8, 0, 5, 11, 0, 1, 5, 5, 6, 11, -1, -1, -1, -1,
        6, 11, 3, 6, 3, 5, 5, 3, 1, -1, -1, -1, -1, -1, -1, -1,
        1, 2, 10, 9, 5, 11, 9, 11, 8, 11, 5, 6, -1, -1, -1, -1,
        0, 11, 3, 0, 6, 11, 0, 9, 6, 5, 6, 9, 1, 2, 10, -1,
        11, 8, 5, 11, 5, 6, 8, 0, 5, 10, 5, 2, 0, 2, 5, -1,
        6, 11, 3, 6, 3, 5, 2, 10, 3, 10, 5, 3, -1, -1, -1, -1,
        5, 8, 9, 5, 2, 8, 5, 6, 2, 3, 8, 2, -1, -1, -1, -1,
        9, 5, 6, 9, 6, 0, 0, 6, 2, -1, -1, -1, -1, -1, -1, -1,
        1, 5, 8, 1, 8, 0, 5, 6, 8, 3, 8, 2, 6, 2, 8, -1,
        1, 5, 6, 2, 1, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 3, 6, 1, 6, 10, 3, 8, 6, 5, 6, 9, 8, 9, 6, -1,
        10, 1, 0, 10, 0, 6, 9, 5, 0, 5, 6, 0, -1, -1, -1, -1,
        0, 3, 8, 5, 6, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        10, 5, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        11, 5, 10, 7, 5, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        11, 5, 10, 11, 7, 5, 8, 3, 0, -1, -1, -1, -1, -1, -1, -1,
        5, 11, 7, 5, 10, 11, 1, 9, 0, -1, -1, -1, -1, -1, -1, -1,
        10, 7, 5, 10, 11, 7, 9, 8, 1, 8, 3, 1, -1, -1, -1, -1,
        11, 1, 2, 11, 7, 1, 7, 5, 1, -1, -1, -1, -1, -1, -1, -1,
        0, 8, 3, 1, 2, 7, 1, 7, 5, 7, 2, 11, -1, -1, -1, -1,
        9, 7, 5, 9, 2, 7, 9, 0, 2, 2, 11, 7, -1, -1, -1, -1,
        7, 5, 2, 7, 2, 11, 5, 9, 2, 3, 2, 8, 9, 8, 2, -1,
        2, 5, 10, 2, 3, 5, 3, 7, 5, -1, -1, -1, -1, -1, -1, -1,
        8, 2, 0, 8, 5, 2, 8, 7, 5, 10, 2, 5, -1, -1, -1, -1,
        9, 0, 1, 5, 10, 3, 5, 3, 7, 3, 10, 2, -1, -1, -1, -1,
        9, 8, 2, 9, 2, 1, 8, 7, 2, 10, 2, 5, 7, 5, 2, -1,
        1, 3, 5, 3, 7, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 8, 7, 0, 7, 1, 1, 7, 5, -1, -1, -1, -1, -1, -1, -1,
        9, 0, 3, 9, 3, 5, 5, 3, 7, -1, -1, -1, -1, -1, -1, -1,
        9, 8, 7, 5, 9, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        5, 8, 4, 5, 10, 8, 10, 11, 8, -1, -1, -1, -1, -1, -1, -1,
        5, 0, 4, 5, 11, 0, 5, 10, 11, 11, 3, 0, -1, -1, -1, -1,
        0, 1, 9, 8, 4, 10, 8, 10, 11, 10, 4, 5, -1, -1, -1, -1,
        10, 11, 4, 10, 4, 5, 11, 3, 4, 9, 4, 1, 3, 1, 4, -1,
        2, 5, 1, 2, 8, 5, 2, 11, 8, 4, 5, 8, -1, -1, -1, -1,
        0, 4, 11, 0, 11, 3, 4, 5, 11, 2, 11, 1, 5, 1, 11, -1,
        0, 2, 5, 0, 5, 9, 2, 11, 5, 4, 5, 8, 11, 8, 5, -1,
        9, 4, 5, 2, 11, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        2, 5, 10, 3, 5, 2, 3, 4, 5, 3, 8, 4, -1, -1, -1, -1,
        5, 10, 2, 5, 2, 4, 4, 2, 0, -1, -1, -1, -1, -1, -1, -1,
        3, 10, 2, 3, 5, 10, 3, 8, 5, 4, 5, 8, 0, 1, 9, -1,
        5, 10, 2, 5, 2, 4, 1, 9, 2, 9, 4, 2, -1, -1, -1, -1,
        8, 4, 5, 8, 5, 3, 3, 5, 1, -1, -1, -1, -1, -1, -1, -1,
        0, 4, 5, 1, 0, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        8, 4, 5, 8, 5, 3, 9, 0, 5, 0, 3, 5, -1, -1, -1, -1,
        9, 4, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        4, 11, 7, 4, 9, 11, 9, 10, 11, -1, -1, -1, -1, -1, -1, -1,
        0, 8, 3, 4, 9, 7, 9, 11, 7, 9, 10, 11, -1, -1, -1, -1,
        1, 10, 11, 1, 11, 4, 1, 4, 0, 7, 4, 11, -1, -1, -1, -1,
        3, 1, 4, 3, 4, 8, 1, 10, 4, 7, 4, 11, 10, 11, 4, -1,
        4, 11, 7, 9, 11, 4, 9, 2, 11, 9, 1, 2, -1, -1, -1, -1,
        9, 7, 4, 9, 11, 7, 9, 1, 11, 2, 11, 1, 0, 8, 3, -1,
        11, 7, 4, 11, 4, 2, 2, 4, 0, -1, -1, -1, -1, -1, -1, -1,
        11, 7, 4, 11, 4, 2, 8, 3, 4, 3, 2, 4, -1, -1, -1, -1,
        2, 9, 10, 2, 7, 9, 2, 3, 7, 7, 4, 9, -1, -1, -1, -1,
        9, 10, 7, 9, 7, 4, 10, 2, 7, 8, 7, 0, 2, 0, 7, -1,
        3, 7, 10, 3, 10, 2, 7, 4, 10, 1, 10, 0, 4, 0, 10, -1,
        1, 10, 2, 8, 7, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        4, 9, 1, 4, 1, 7, 7, 1, 3, -1, -1, -1, -1, -1, -1, -1,
        4, 9, 1, 4, 1, 7, 0, 8, 1, 8, 7, 1, -1, -1, -1, -1,
        4, 0, 3, 7, 4, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        4, 8, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        9, 10, 8, 10, 11, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        3, 0, 9, 3, 9, 11, 11, 9, 10, -1, -1, -1, -1, -1, -1, -1,
        0, 1, 10, 0, 10, 8, 8, 10, 11, -1, -1, -1, -1, -1, -1, -1,
        3, 1, 10, 11, 3, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 2, 11, 1, 11, 9, 9, 11, 8, -1, -1, -1, -1, -1, -1, -1,
        3, 0, 9, 3, 9, 11, 1, 2, 9, 2, 11, 9, -1, -1, -1, -1,
        0, 2, 11, 8, 0, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        3, 2, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        2, 3, 8, 2, 8, 10, 10, 8, 9, -1, -1, -1, -1, -1, -1, -1,
        9, 10, 2, 0, 9, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        2, 3, 8, 2, 8, 10, 0, 1, 8, 1, 10, 8, -1, -1, -1, -1,
        1, 10, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        1, 3, 8, 9, 1, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 9, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        0, 3, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1
};


void MarchingCubes_Voxel(Vector3D PixelOrigin, float VoxelScaleSize, float Threshold)
{

        int i;
        Vector3D PixelCoords[V_CARD];
        Vector3D VoxelCoords;
        float Phi_Pixel[V_CARD];
        EdgeSubset eSSet = 0;           // initialize to empty set
        VertexSubset vSSet = 0;
        VertexLabel iv0, iv1;
        Vector3D SurfacePoint[E_CARD];
        Vector3D SurfacePointNormal[E_CARD];
        int triangle;
        //int i1, i2, ii;
        EdgeLabel iEdgeSurfacePt[3];
        EdgeLabel iEdgePt;

        // Build VertexSubset of vertices inside the implicit function
        for (i=0; i<V_CARD; i++) {
                // View Voxel as in the Pixel Coordinate Frame
                VoxelCoords = VectorScalarMult( VertexToVector3D(voxel.v[i]), VoxelScaleSize);
                PixelCoords[i] = VectorAdd(PixelOrigin, VoxelCoords);

                // Calculate Phi(v=xyz) for each of the Voxel's vertices v
                Phi_Pixel[i] = Phi3D(PixelCoords[i]);

                // g(xyz) = phi(xyz) - threshold = 0. A point xyz is inside if g(xyz) <= 0 else outside
                if (Phi_Pixel[i] <= Threshold) {
                        vSSet = VertexSubsetAddElement(vSSet, i);
                }
        }

        // Lookup Edges of Voxel that intersect with the implicit function
        eSSet = Map_VertexSubset_To_EdgeSubset[vSSet];
        if (eSSet == 0) return; // if empty set, return.

        for (i=0; i<E_CARD; i++) {
                // the edge e_i, labeled i, within Edge Subset, eSSet...
                if ( SET_MEMBER(i, eSSet) ) {
                        // edge = v0v1. Denote by VertexLabels instead of Vertex.
                        iv0 = voxel.e[i].v0; //E_Voxel[2*i];
                        iv1 = voxel.e[i].v1;
                        // Intersecting Point on Implicit function between vertice's iv0 and iv1
                        SurfacePoint[i] = vLinearInterpolation(PixelCoords[iv0], PixelCoords[iv1],
                                Threshold);
                        SurfacePointNormal[i] = VertexPointNormal(SurfacePoint[i]);
                }
        }

        triangle = 0; iEdgePt = 0;
        // Data is matrix[VSS_CARD][5][3] with Index of "IDX3(VSS_CARD, 5, 3, i1, i2, i3)+i1".
        // where i1 is VertexSubset, i2 is triangle number, and i3 is xyz coordinates.
        while (1) {
                iEdgePt = Map_VertexSubset_To_TriangleList[IDX3(VSS_CARD, 5,3, vSSet, triangle, 0)+ vSSet];
                if (iEdgePt == -1) break;
                iEdgeSurfacePt[0] = iEdgePt;
                iEdgeSurfacePt[1] = Map_VertexSubset_To_TriangleList[IDX3(VSS_CARD, 5, 3, vSSet, triangle, 1)+ vSSet];
                iEdgeSurfacePt[2] = Map_VertexSubset_To_TriangleList[IDX3(VSS_CARD, 5, 3, vSSet, triangle, 2)+ vSSet];

                // Printout Vertices and Normals with their labels and vector values
                Vector3D v1, v2, v3;
                Vector3D n1, n2, n3;
                Face f;
                v1.x = SurfacePoint[iEdgeSurfacePt[0]].x;
                v1.y = SurfacePoint[iEdgeSurfacePt[0]].y;
                v1.z = SurfacePoint[iEdgeSurfacePt[0]].z;
                g_vertices.push_back(v1);
                v2.x = SurfacePoint[iEdgeSurfacePt[1]].x;
                v2.y = SurfacePoint[iEdgeSurfacePt[1]].y;
                v2.z = SurfacePoint[iEdgeSurfacePt[1]].z;
                g_vertices.push_back(v2);
                v3.x = SurfacePoint[iEdgeSurfacePt[2]].x;
                v3.y = SurfacePoint[iEdgeSurfacePt[2]].y;
                v3.z = SurfacePoint[iEdgeSurfacePt[2]].z;
                g_vertices.push_back(v3);
                n1.x = SurfacePointNormal[iEdgeSurfacePt[0]].x;
                n1.y = SurfacePointNormal[iEdgeSurfacePt[0]].y;
                n1.z = SurfacePointNormal[iEdgeSurfacePt[0]].z;
                g_normals.push_back(n1);
                n2.x = SurfacePointNormal[iEdgeSurfacePt[1]].x;
                n2.y = SurfacePointNormal[iEdgeSurfacePt[1]].y;
                n2.z = SurfacePointNormal[iEdgeSurfacePt[1]].z;
                g_normals.push_back(n2);
                n3.x = SurfacePointNormal[iEdgeSurfacePt[2]].x;
                n3.y = SurfacePointNormal[iEdgeSurfacePt[2]].y;
                n3.z = SurfacePointNormal[iEdgeSurfacePt[2]].z;
                g_normals.push_back(n3);
                f.v1 = g_v_n+0;
                f.v2 = g_v_n+1;
                f.v3 = g_v_n+2;
                g_faces.push_back(f);

                g_v_n += 3; // three new vertices added. Keeps track of number of vertices
                g_t_n++;        // one new triangle added. Keeps track of number of triangles.

                triangle++;
        }
}

void MarchingCubes(float VoxelScaleSize, float Threshold)
{
        float xs, ys, zs, xe, ye, ze;
        float x, y, z;
        Vector3D PixelOrigin;
        float dx, dy, dz;
        //int flag1;

        xs = ys = zs = DLOW; // -200 //-1000 EDIT
        xe = ze = ye = DHI;  // 200 // 1000 EDIT

        // http://atrey.karlin.mff.cuni.cz/~0rfelyus/povray/index.html
        // Classical Blob (Jim Blinn) - no polynomial approx. - Blob
        dx = dy = dz = DN;

        z = zs;
        while (z<ze) {
                y = ys;
                while (y<ye) {
                        x = xs;
                        while (x<xe) {
                                PixelOrigin.x = x;
                                PixelOrigin.y = y;
                                PixelOrigin.z = z;

                                MarchingCubes_Voxel(PixelOrigin, VoxelScaleSize, Threshold);
                                x += dx;
                        }
                        y += dy;
                }
                printf("Slice %03f...", z);
                z+= dz;
        }
        printf("\n");
}
